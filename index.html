<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‹¸ç‰‡ç¶­ä¿®é …ç›®ç®¡ç†</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans TC', 'sans-serif'],
                    },
                    colors: {
                        primary: '#059669', /* ç¶ è‰²ç³»ï¼Œä»£è¡¨ç¶­è­·èˆ‡é€²åº¦ */
                        secondary: '#34d399',
                        warning: '#f97316',
                        info: '#3b82f6',
                        success: '#10b981',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #f0fdf4; /* æ·ºç¶ è‰²èƒŒæ™¯ */
            min-height: 100vh;
        }
        .container-content {
            max-width: 1500px;
        }
        .status-pill {
            padding: 2px 8px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.open {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        .modal-overlay.open .modal-content {
            transform: scale(1);
        }

        /* é€²åº¦æ¢æ¨£å¼ */
        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            position: relative;
            flex-grow: 1;
            padding: 0 5px;
        }
        .step-indicator {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            z-index: 10;
            transition: background-color 0.3s, border-color 0.3s;
            margin-bottom: 8px;
        }
        .step-done .step-indicator {
            background-color: '#10b981'; /* success */
        }
        .step-current .step-indicator {
            background-color: '#3b82f6'; /* info */
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.3);
        }
        .step-pending .step-indicator {
            background-color: '#e5e7eb'; /* gray-200 */
            color: '#9ca3af'; /* gray-400 */
        }
        .step-done .step-label, .step-current .step-label {
            color: '#1f2937'; /* gray-800 */
            font-weight: 600;
        }
        
    </style>
</head>
<body class="font-sans">
    <div class="container-content mx-auto p-4 sm:p-6 lg:p-8">
        <header class="mb-8">
            <h1 class="text-4xl font-extrabold text-primary mb-2 text-center">é‹¸ç‰‡ç¶­ä¿®é …ç›®ç®¡ç†</h1>
            <p class="text-gray-600 text-center">è¨˜éŒ„å®¢æˆ¶é€ä¿®çš„æ¯ä¸€ç‰‡é‹¸ç‰‡ã€‚åŒ…å«è¦æ ¼ã€å®¢æˆ¶ç·¨è™Ÿå’Œç³»çµ± IDã€‚</p>
        </header>
        
        <!-- æ¬Šé™æ¨¡å¼åˆ‡æ› -->
        <div class="flex justify-center mb-6">
            <div class="inline-flex rounded-md shadow-sm">
                <button id="mode-internal" class="px-4 py-2 text-sm font-medium rounded-l-lg transition duration-150 border border-primary/50 bg-primary text-white">
                    å…¬å¸å…§éƒ¨è¦–åœ– (ç®¡ç†)
                </button>
                <button id="mode-customer" class="px-4 py-2 text-sm font-medium rounded-r-lg transition duration-150 border border-primary/50 bg-white text-primary hover:bg-green-50">
                    å®¢æˆ¶æŸ¥è©¢è¦–åœ–
                </button>
            </div>
        </div>

        <!-- å®¢æˆ¶æŸ¥è©¢ä»‹é¢ (åƒ…åœ¨å®¢æˆ¶æ¨¡å¼é¡¯ç¤º) -->
        <section id="customer-search-section" class="bg-white p-6 rounded-xl shadow-2xl mb-8 border border-info/30 hidden">
            <h2 class="text-2xl font-bold mb-4 text-info">å®¢æˆ¶ç¶­ä¿®é€²åº¦æŸ¥è©¢</h2>
            <p class="text-gray-600 mb-4">è«‹è¼¸å…¥æ‚¨çš„ç¶­ä¿®ç·¨è™Ÿæˆ–å®¢æˆ¶åç¨±å’Œå ±åƒ¹æ—¥æœŸé€²è¡ŒæŸ¥è©¢ã€‚</p>
            
            <!-- æŸ¥è©¢è¼¸å…¥å€ -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                <input type="text" id="customer-serial-search" placeholder="è¼¸å…¥ç¶­ä¿®ç·¨è™Ÿ (å„ªå…ˆæŸ¥è©¢)"
                       class="col-span-1 md:col-span-2 p-3 border border-gray-300 rounded-lg focus:ring-info focus:border-info transition duration-150">
                <input type="text" id="customer-name-search" placeholder="å®¢æˆ¶åç¨±"
                       class="col-span-1 p-3 border border-gray-300 rounded-lg focus:ring-info focus:border-info transition duration-150">
                <input type="date" id="customer-date-search" placeholder="å ±åƒ¹æ—¥æœŸ"
                       class="col-span-1 p-3 border border-gray-300 rounded-lg focus:ring-info focus:border-info transition duration-150">
            </div>
            
            <button id="run-customer-search" class="bg-info text-white py-3 px-6 rounded-lg font-bold hover:bg-blue-700 transition duration-300 shadow-lg w-full md:w-auto">
                æŸ¥è©¢æˆ‘çš„é‹¸ç‰‡é€²åº¦
            </button>
            
            <p id="customer-search-message" class="mt-4 text-sm"></p>

            <!-- å®¢æˆ¶æŸ¥è©¢çµæœå„ªåŒ–ä»‹é¢ -->
            <div id="customer-result-container" class="mt-8 pt-6 border-t border-gray-200 hidden">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 border-b pb-4">
                    <h3 class="text-3xl font-extrabold text-gray-800 mb-2 md:mb-0">
                        ç¶­ä¿®å–®è™Ÿ: <span id="customer-result-serial" class="text-primary"></span>
                    </h3>
                    <div class="text-lg font-semibold text-gray-600">
                         å®¢æˆ¶: <span id="customer-result-name" class="text-info"></span>
                    </div>
                </div>

                <!-- è¦–è¦ºåŒ–é€²åº¦æ¢ -->
                <h4 class="text-xl font-bold mb-4 text-gray-700">âš™ï¸ ç¶­ä¿®æµç¨‹é€²åº¦</h4>
                <div class="relative pt-1 mb-8">
                    <div class="overflow-hidden mb-4 text-xs flex rounded-full h-2 bg-gray-200">
                        <div id="progress-bar-fill" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-success transition-all duration-700 ease-in-out" style="width: 0%"></div>
                    </div>
                    <div id="customer-progress-display" class="flex justify-between items-start overflow-x-auto pb-2">
                        <!-- é€²åº¦æ­¥é©Ÿå°‡ç”± JS æ¸²æŸ“ -->
                    </div>
                </div>

                <!-- ç…§ç‰‡èˆ‡ç‰¹æ®Šéœ€æ±‚ -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-8">
                    <div id="customer-photo-display" class="md:col-span-2 space-y-4">
                        <h4 class="text-xl font-bold text-gray-700">ğŸ“¸ ç´€éŒ„ç…§ç‰‡</h4>
                        <div id="photo-before-container"></div>
                        <div id="photo-after-container"></div>
                        <p id="photo-pending-message" class="text-gray-500 italic text-sm"></p>
                    </div>

                    <div class="md:col-span-1 bg-yellow-50 p-4 rounded-xl border border-warning/30">
                        <h4 class="text-xl font-bold text-warning mb-3">ğŸ› ï¸ ç‰¹æ®Šç¶­ä¿®é …ç›®</h4>
                        <div id="conditional-display" class="space-y-2">
                            <p id="toothing-status" class="text-sm text-gray-700">è£œé½’: <span class="font-semibold">N/A</span></p>
                            <p id="correction-status" class="text-sm text-gray-700">é‹¼æ¿æ ¡æ­£: <span class="font-semibold">N/A</span></p>
                        </div>
                    </div>
                </div>

            </div>
        </section>


        <!-- æ–°å¢ç¶­ä¿®é …ç›®å€å¡Š (åƒ…åœ¨å…§éƒ¨æ¨¡å¼é¡¯ç¤º) - ä¿æŒä¸è®Š -->
        <section id="add-item" class="bg-white p-6 rounded-xl shadow-lg mb-8 border border-primary/30">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800">æ–°å¢ç¶­ä¿®é …ç›® (é‹¸ç‰‡è¦æ ¼èˆ‡å®¢æˆ¶è³‡è¨Š)</h2>
            <div id="auth-status" class="text-sm mb-4">æ­£åœ¨åˆå§‹åŒ–...</div>

            <form id="item-form" class="grid grid-cols-2 md:grid-cols-6 gap-4 items-end">
                <!-- å®¢æˆ¶åç¨± -->
                <div class="col-span-2 md:col-span-2">
                    <label for="customer-name" class="block text-sm font-medium text-gray-700 mb-1">å®¢æˆ¶åç¨±</label>
                    <input type="text" id="customer-name" required placeholder="è«‹è¼¸å…¥å®¢æˆ¶åç¨±"
                           class="w-full p-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-150">
                </div>
                <!-- å®¢æˆ¶æä¾›ç·¨è™Ÿ -->
                <div class="col-span-2 md:col-span-2">
                    <label for="serial-number" class="block text-sm font-medium text-gray-700 mb-1">ç·¨è™Ÿ (å®¢æˆ¶æä¾›)</label>
                    <input type="text" id="serial-number" required placeholder="è«‹è¼¸å…¥é‹¸ç‰‡å”¯ä¸€ç·¨è™Ÿ"
                           class="w-full p-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-150">
                </div>
                
                <!-- å ±åƒ¹æ—¥æœŸ -->
                <div class="col-span-2 md:col-span-2">
                    <label for="quote-date" class="block text-sm font-medium text-gray-700 mb-1">å ±åƒ¹æ—¥æœŸ</label>
                    <input type="date" id="quote-date" required
                           class="w-full p-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-150">
                </div>

                <!-- å¤–å¾‘ (D) -->
                <div class="col-span-1">
                    <label for="outer-diameter" class="block text-sm font-medium text-gray-700 mb-1">å¤–å¾‘ (D)</label>
                    <input type="text" id="outer-diameter" required placeholder="ä¾‹å¦‚ï¼š305mm"
                           class="w-full p-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-150">
                </div>
                 <!-- å…§å­” (d) -->
                <div class="col-span-1">
                    <label for="inner-bore" class="block text-sm font-medium text-gray-700 mb-1">å…§å­” (d)</label>
                    <input type="text" id="inner-bore" required placeholder="ä¾‹å¦‚ï¼š25.4mm"
                           class="w-full p-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-150">
                </div>
                <!-- åšåº¦ (B) -->
                <div class="col-span-1">
                    <label for="thickness" class="block text-sm font-medium text-gray-700 mb-1">åšåº¦ (B)</label>
                    <input type="text" id="thickness" required placeholder="ä¾‹å¦‚ï¼š2.8mm"
                           class="w-full p-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-150">
                </div>
                <!-- é½’æ•¸ (Z) -->
                <div class="col-span-1">
                    <label for="teeth-count" class="block text-sm font-medium text-gray-700 mb-1">é½’æ•¸ (Z)</label>
                    <input type="text" id="teeth-count" required placeholder="ä¾‹å¦‚ï¼š40T"
                           class="w-full p-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-150">
                </div>
                
                <!-- åŠŸèƒ½/æè³ª -->
                <div class="col-span-2">
                    <label for="function-type" class="block text-sm font-medium text-gray-700 mb-1">åŠŸèƒ½/æè³ª</label>
                    <select id="function-type" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-150 bg-white">
                        <option value="">è«‹é¸æ“‡ç”¨é€”</option>
                        <option value="æœ¨å·¥">æœ¨å·¥</option>
                        <option value="éµå·¥">éµå·¥</option>
                        <option value="é‹ç”¨">é‹ç”¨</option>
                        <option value="å¡‘è† ">å¡‘è† </option>
                        <option value="HSS">HSS</option>
                        <option value="åˆ€å…·">åˆ€å…· (ç‰¹æ®Š)</option>
                    </select>
                </div>
                
                <!-- å‚™è¨»/èªªæ˜ -->
                <div class="col-span-6 md:col-span-4">
                    <label for="notes" class="block text-sm font-medium text-gray-700 mb-1">åˆå§‹å‚™è¨»/å®¢æˆ¶å•é¡Œ</label>
                    <textarea id="notes" rows="1" placeholder="ä¾‹å¦‚ï¼šå®¢æˆ¶åæ‡‰åˆ‡å‰Šä¸é †"
                           class="w-full p-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-150"></textarea>
                </div>

                <!-- æŒ‰éˆ• -->
                <div class="col-span-6 md:col-span-2">
                    <button type="submit" id="submit-button" disabled
                            class="w-full bg-primary text-white py-3 px-4 rounded-lg font-bold hover:bg-green-700 transition duration-300 shadow-md disabled:bg-gray-400">
                        æ–°å¢ç¶­ä¿®é …ç›®
                    </button>
                </div>
            </form>
            <p id="form-message" class="mt-3 text-sm"></p>
        </section>

        <!-- é …ç›®æ¸…å–®èˆ‡æŸ¥è©¢å€å¡Š (åƒ…åœ¨å…§éƒ¨æ¨¡å¼é¡¯ç¤º) - ä¿æŒä¸è®Š -->
        <section id="item-list-section" class="bg-white p-6 rounded-xl shadow-lg border border-primary/30">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800">ç¶­ä¿®é …ç›®æ¸…å–® (å…± <span id="item-count">0</span> ç­†)</h2>

            <!-- æŸ¥è©¢è¼¸å…¥æ¡† -->
            <div class="mb-6">
                <label for="search-input" class="block text-sm font-medium text-gray-700 mb-1">
                    å…¬å¸å…§éƒ¨æŸ¥è©¢ (ç·¨è™Ÿã€åç¨±ã€è¦æ ¼)
                </label>
                <input type="text" id="search-input" placeholder="å¯è¼¸å…¥å®¢æˆ¶ç·¨è™Ÿã€å®¢æˆ¶åç¨±æˆ–è¦æ ¼é€²è¡Œç¯©é¸"
                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-150">
            </div>

            <!-- é …ç›®è¡¨æ ¼ (éŸ¿æ‡‰å¼è¨­è¨ˆ) -->
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-green-50">
                        <tr>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider min-w-[100px]">å®¢æˆ¶åç¨±</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider min-w-[100px]">ç·¨è™Ÿ (å®¢æˆ¶æä¾›)</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider min-w-[80px]">å ±åƒ¹æ—¥æœŸ</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider min-w-[80px]">è¦æ ¼ (D/d/B/Z)</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider min-w-[100px]">åŠŸèƒ½</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider min-w-[120px]">ç›®å‰é€²åº¦</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-[180px]">æ“ä½œ/ID</th>
                        </tr>
                    </thead>
                    <tbody id="items-table-body" class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td colspan="7" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">
                                è¼‰å…¥ä¸­...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div id="no-results" class="hidden text-center py-4 text-gray-500 mt-4">
                æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„ç¶­ä¿®é …ç›®è¨˜éŒ„ã€‚
            </div>
        </section>
    </div>
    
    <!-- æ¨¡æ…‹æ¡†: é€²åº¦æ›´æ–°/è©³ç´°è³‡è¨Š (å·²æ›´æ–°ç…§ç‰‡ä¸Šå‚³å€å¡Š) -->
    <div id="progress-modal-overlay" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-2xl font-bold mb-4 text-primary">ç¶­ä¿®å–®é€²åº¦èˆ‡è©³ç´°è³‡æ–™</h3>
            <p class="text-sm text-gray-600 mb-4">ç¶­ä¿®é …ç›®: <span id="modal-item-info" class="font-semibold text-gray-800"></span></p>

            <form id="progress-form">
                <input type="hidden" id="modal-item-id">
                
                <!-- ç¶­ä¿®å–®ç‹€æ…‹é¸æ“‡ -->
                <div class="mb-4">
                    <label for="modal-status-select" class="block text-sm font-medium text-gray-700 mb-1">æµç¨‹ç‹€æ…‹</label>
                    <select id="modal-status-select" class="w-full p-2 border border-gray-300 rounded-lg bg-white"></select>
                </div>
                
                <!-- æ¢ä»¶å¼ç‹€æ…‹ -->
                <div id="conditional-statuses" class="mb-4 space-y-2 p-3 border rounded-lg bg-gray-50">
                    <h4 class="text-sm font-semibold text-gray-700">æ¢ä»¶å¼ç¶­ä¿®é …ç›® (ä¾éœ€æ±‚å‹¾é¸):</h4>
                    <label class="flex items-center text-sm text-gray-700">
                        <input type="checkbox" id="modal-toothing" class="form-checkbox h-4 w-4 text-primary rounded border-gray-300">
                        <span class="ml-2">è£œé½’ (è‹¥æœ‰æ–·é½’)</span>
                    </label>
                    <label class="flex items-center text-sm text-gray-700">
                        <input type="checkbox" id="modal-plate-correction" class="form-checkbox h-4 w-4 text-primary rounded border-gray-300">
                        <span class="ml-2">é‹¼æ¿æ ¡æ­£ (è‹¥æœ‰åæ¿)</span>
                    </label>
                </div>

                <!-- ç…§ç‰‡ç®¡ç† (ç›´æ¥ä¸Šå‚³ Base64) -->
                <div class="mb-4 p-3 border rounded-lg bg-yellow-50/50">
                    <h4 class="text-sm font-semibold text-gray-700 mb-2">ğŸ“¸ ç…§ç‰‡ç®¡ç† (ç›´æ¥ä¸Šå‚³ï¼Œè‡ªå‹•è½‰æ›ç‚º Base64 å„²å­˜)</h4>
                    
                    <!-- ç¶­ä¿®å‰ç…§ç‰‡ -->
                    <div class="mb-4">
                        <label for="modal-file-before" class="block text-xs font-medium text-gray-700 mb-1">ç¶­ä¿®å‰ç…§ç‰‡ä¸Šå‚³ (é»æ“Šé¸å–æª”æ¡ˆ)</label>
                        <input type="file" id="modal-file-before" accept="image/*" class="w-full p-2 mb-2 text-sm border rounded-lg bg-white">
                        <input type="hidden" id="modal-base64-before"> <!-- å„²å­˜ Base64 è³‡æ–™ -->
                        <div id="modal-preview-before" class="mt-2 h-20 w-auto max-w-full overflow-hidden rounded-lg border border-dashed border-gray-300 flex justify-center items-center">
                            <span class="text-xs text-gray-400">ç¶­ä¿®å‰é è¦½åœ–</span>
                        </div>
                    </div>
                    
                    <!-- å‡ºè²¨å¾Œç…§ç‰‡ -->
                    <div>
                        <label for="modal-file-after" class="block text-xs font-medium text-gray-700 mb-1">å‡ºè²¨å‰ç…§ç‰‡ä¸Šå‚³ (é»æ“Šé¸å–æª”æ¡ˆ)</label>
                        <input type="file" id="modal-file-after" accept="image/*" class="w-full p-2 mb-2 text-sm border rounded-lg bg-white">
                        <input type="hidden" id="modal-base64-after"> <!-- å„²å­˜ Base64 è³‡æ–™ -->
                        <div id="modal-preview-after" class="mt-2 h-20 w-auto max-w-full overflow-hidden rounded-lg border border-dashed border-gray-300 flex justify-center items-center">
                            <span class="text-xs text-gray-400">å‡ºè²¨å‰é è¦½åœ–</span>
                        </div>
                    </div>
                    
                    <p class="text-xs text-red-500 mt-1">æ³¨æ„ï¼šBase64 åœ–ç‰‡æœƒå¢åŠ è³‡æ–™åº«æ–‡ä»¶å¤§å°ï¼Œè«‹ç›¡é‡ä½¿ç”¨å£“ç¸®éçš„å°å°ºå¯¸åœ–ç‰‡ã€‚</p>
                </div>

                <!-- å‚™è¨» -->
                <div class="mb-6">
                    <label for="modal-notes" class="block text-sm font-medium text-gray-700 mb-1">å‚™è¨»/è™•ç†èªªæ˜</label>
                    <textarea id="modal-notes" rows="3" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary"></textarea>
                </div>

                <div class="flex justify-end space-x-3">
                    <button type="button" id="modal-close-button" class="bg-gray-300 text-gray-800 py-2 px-4 rounded-lg font-bold hover:bg-gray-400 transition duration-300">
                        å–æ¶ˆ
                    </button>
                    <button type="submit" class="bg-info text-white py-2 px-4 rounded-lg font-bold hover:bg-info/90 transition duration-300">
                        æ›´æ–°é€²åº¦èˆ‡å‚™è¨»
                    </button>
                </div>
                <p id="modal-message" class="mt-3 text-sm"></p>
            </form>
        </div>
    </div>


    <!-- Firebase è…³æœ¬ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, updateDoc, deleteDoc, collection, query, onSnapshot, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // è¨­å®š Firebase Debug Log
        setLogLevel('Debug');

        // --- å…¨åŸŸè®Šæ•¸åˆå§‹åŒ– ---
        // 1. App IDï¼šç”¨æ–¼ Firestore è·¯å¾‘ï¼Œè‡ªå®šç¾©å³å¯
        const appId = 'saw-blade-management'; 

        // 2. Firebase è¨­å®šï¼šç•¶æ‚¨åœ¨æœ¬æ©Ÿæˆ– NAS åŸ·è¡Œæ™‚ï¼ŒCanvas çš„å…¨åŸŸè®Šæ•¸æœƒéºå¤±ã€‚
        // !!! è«‹å°‡ä¸‹æ–¹çš„ YOUR_... æ›¿æ›æˆæ‚¨åœ¨ Firebase Console å–å¾—çš„çœŸå¯¦è¨­å®š !!!
        const MY_FIREBASE_CONFIG = {
            apiKey: "YOUR_API_KEY_HERE", 
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_WEB_APP_ID"
        };

        // æª¢æŸ¥ Canvas ç’°å¢ƒè®Šæ•¸ã€‚å¦‚æœæ‰¾ä¸åˆ°ï¼ˆåœ¨æœ¬æ©Ÿæˆ– NAS é‹è¡Œï¼‰ï¼Œå‰‡ä½¿ç”¨æˆ‘å€‘ç¡¬ç·¨ç¢¼çš„é…ç½®ã€‚
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : MY_FIREBASE_CONFIG; 
            
        // åœ¨é Canvas ç’°å¢ƒä¸­ï¼Œåˆå§‹åŒ– Token è¨­ç‚º null
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; 

        let app, db, auth, userId = null;
        let isAuthReady = false;
        const COLLECTION_NAME = 'saw_blade_repairs'; 

        // æ ¸å¿ƒç‹€æ…‹åˆ—è¡¨
        const STATUS_FLOW = [
            'æ”¶åˆ° (Received)', 'é¡¯å¾®æª¢æŸ¥ (Micro-Inspection)', 'æµ¸æ³¡è—¥æ°´ (Soaking)', 
            'æ¸…æ½” (Cleaning)', 'ç ”ç£¨ (Grinding)', 'ä¸Šæ²¹ (Oiling)', 'æª¢æŸ¥ (Final Check)', 
            'å‡ºè²¨ (Shipped)', 'å¾…å–ä»¶ (Ready for Pickup)', 'å¾…å¯„è²¨ (Ready for Mail)'
        ];
        
        // å°‡æµç¨‹ç‹€æ…‹åˆ†ç‚º "ç¶­ä¿®ä¸­" å’Œ "å®Œæˆ/å‡ºè²¨" å…©å€‹é¡åˆ¥ï¼Œç”¨æ–¼è¦–è¦ºåŒ–é€²åº¦æ¢
        const PROGRESS_STEPS = STATUS_FLOW.slice(0, 7).map(s => s.split(' (')[0]); // åªå–ç¶­ä¿®ä¸­çš„å‰7æ­¥
        const FINAL_STEPS = STATUS_FLOW.slice(7).map(s => s.split(' (')[0]); // å®Œæˆ/å‡ºè²¨çš„å¾Œ3æ­¥

        // --- DOM å…ƒç´  ---
        const authStatusEl = document.getElementById('auth-status');
        const submitButton = document.getElementById('submit-button');
        const itemForm = document.getElementById('item-form');
        const itemsTableBody = document.getElementById('items-table-body');
        const searchInput = document.getElementById('search-input');
        const itemCountEl = document.getElementById('item-count');
        const addItemSection = document.getElementById('add-item');
        const itemListSection = document.getElementById('item-list-section');
        
        // æ¨¡å¼åˆ‡æ›
        const modeInternalBtn = document.getElementById('mode-internal');
        const modeCustomerBtn = document.getElementById('mode-customer');
        const customerSearchSection = document.getElementById('customer-search-section');

        // å®¢æˆ¶æŸ¥è©¢
        const customerSerialSearch = document.getElementById('customer-serial-search');
        const customerNameSearch = document.getElementById('customer-name-search');
        const customerDateSearch = document.getElementById('customer-date-search');
        const runCustomerSearchBtn = document.getElementById('run-customer-search');
        const customerResultContainer = document.getElementById('customer-result-container');
        const customerProgressDisplay = document.getElementById('customer-progress-display');
        const progressBarFill = document.getElementById('progress-bar-fill');
        const customerPhotoDisplay = document.getElementById('customer-photo-display');
        const photoBeforeContainer = document.getElementById('photo-before-container');
        const photoAfterContainer = document.getElementById('photo-after-container');
        const photoPendingMessage = document.getElementById('photo-pending-message');
        const conditionalDisplay = document.getElementById('conditional-display');
        const customerSearchMessage = document.getElementById('customer-search-message');

        // æ¨¡æ…‹æ¡†å…ƒç´ 
        const modalOverlay = document.getElementById('progress-modal-overlay');
        const modalCloseBtn = document.getElementById('modal-close-button');
        const progressForm = document.getElementById('progress-form');
        const modalStatusSelect = document.getElementById('modal-status-select');
        const modalItemId = document.getElementById('modal-item-id');
        const modalItemInfo = document.getElementById('modal-item-info');
        const modalToothing = document.getElementById('modal-toothing');
        const modalPlateCorrection = document.getElementById('modal-plate-correction');
        const modalNotes = document.getElementById('modal-notes');
        const modalMessage = document.getElementById('modal-message');

        // æ–°å¢/ä¿®æ”¹çš„ç…§ç‰‡ä¸Šå‚³ç›¸é—œ DOM
        const modalFileBefore = document.getElementById('modal-file-before');
        const modalBase64Before = document.getElementById('modal-base64-before');
        const modalPreviewBefore = document.getElementById('modal-preview-before');
        const modalFileAfter = document.getElementById('modal-file-after');
        const modalBase64After = document.getElementById('modal-base64-after');
        const modalPreviewAfter = document.getElementById('modal-preview-after');


        let allItems = []; // å„²å­˜æ‰€æœ‰ç¶­ä¿®é …ç›®è³‡æ–™
        let currentMode = 'internal'; // 'internal' or 'customer'

        // åˆå§‹åŒ–ç‹€æ…‹é¸é …åˆ°æ¨¡æ…‹æ¡†
        STATUS_FLOW.forEach(status => {
            const option = document.createElement('option');
            option.value = status;
            option.textContent = status.split(' (')[0]; // åªé¡¯ç¤ºä¸­æ–‡éƒ¨åˆ†
            modalStatusSelect.appendChild(option);
        });

        // --- è¼”åŠ©å‡½æ•¸ï¼šåœ–ç‰‡æª”æ¡ˆè½‰ Base64 ---
        function fileToBase64(fileInput, base64HiddenInput, previewElement) {
            const file = fileInput.files[0];
            if (!file) return;

            // ç¢ºä¿æª”æ¡ˆå°æ–¼ 1MBï¼Œé¿å… Firestore æ–‡ä»¶éå¤§
            if (file.size > 1024 * 1024) { 
                // æ”¹ç”¨è‡ªå®šç¾©é€šçŸ¥ä»£æ›¿ alert
                showCustomMessage('åœ–ç‰‡æª”æ¡ˆéå¤§ï¼Œè«‹é¸æ“‡å°æ–¼ 1MB çš„åœ–ç‰‡ä»¥ç¢ºä¿è³‡æ–™åº«ç©©å®šã€‚', 'error');
                fileInput.value = '';
                base64HiddenInput.value = '';
                previewElement.innerHTML = '<span class="text-xs text-red-500">æª”æ¡ˆéå¤§</span>';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const base64String = e.target.result;
                base64HiddenInput.value = base64String;
                previewElement.innerHTML = `<img src="${base64String}" class="h-20 w-auto max-w-full object-contain">`;
            };
            reader.readAsDataURL(file);
        }

        // ç¶å®šæª”æ¡ˆé¸æ“‡äº‹ä»¶
        modalFileBefore.addEventListener('change', () => fileToBase64(modalFileBefore, modalBase64Before, modalPreviewBefore));
        modalFileAfter.addEventListener('change', () => fileToBase64(modalFileAfter, modalBase64After, modalPreviewAfter));

        // æ¸…é™¤é è¦½å’Œ Base64 å€¼
        function resetPhotoInputs() {
            modalFileBefore.value = '';
            modalBase64Before.value = '';
            modalPreviewBefore.innerHTML = '<span class="text-xs text-gray-400">ç¶­ä¿®å‰é è¦½åœ–</span>';
            
            modalFileAfter.value = '';
            modalBase64After.value = '';
            modalPreviewAfter.innerHTML = '<span class="text-xs text-gray-400">å‡ºè²¨å‰é è¦½åœ–</span>';
        }

        function updatePreview(base64String, previewElement, defaultText) {
            if (base64String) {
                // æª¢æŸ¥æ˜¯å¦ç‚º Base64 (ä»¥ data:image é–‹é ­)
                const isBase64 = base64String.startsWith('data:image');
                if (isBase64) {
                    previewElement.innerHTML = `<img src="${base64String}" class="h-20 w-auto max-w-full object-contain">`;
                } else {
                    // å¦‚æœå­˜çš„ä¸æ˜¯ Base64 è€Œæ˜¯èˆŠçš„ URL æ ¼å¼ï¼Œå‰‡é¡¯ç¤ºé€£çµå­—æ¨£
                    previewElement.innerHTML = `<span class="text-xs text-info">é€£çµ (èˆŠæ ¼å¼)</span>`;
                }
            } else {
                previewElement.innerHTML = `<span class="text-xs text-gray-400">${defaultText}</span>`;
            }
        }
        
        // --- è¼”åŠ©å‡½æ•¸ï¼šè³‡æ–™åº«è·¯å¾‘ ---
        function getCollectionRef() {
            if (!db || !userId) return null;
            // ç§æœ‰è³‡æ–™è·¯å¾‘: /artifacts/{appId}/users/{userId}/{collectionName}
            return collection(db, 'artifacts', appId, 'users', userId, COLLECTION_NAME);
        }

        // --- 1. åˆå§‹åŒ– Firebase èˆ‡èªè­‰ ---
        async function initializeFirebase() {
            try {
                if (Object.keys(firebaseConfig).length === 0 || !firebaseConfig.projectId || firebaseConfig.projectId === "YOUR_PROJECT_ID") {
                    authStatusEl.innerHTML = `
                        <span class="text-red-600 font-bold">éŒ¯èª¤ï¼šFirebase è¨­å®šéºå¤±æˆ–ç‚ºé è¨­ä½”ä½ç¬¦ï¼</span>
                        <br>è«‹åœ¨ç¨‹å¼ç¢¼ä¸­ä¿®æ”¹ **MY_FIREBASE_CONFIG** æ›¿æ›æˆæ‚¨çš„çœŸå¯¦å°ˆæ¡ˆè¨­å®šã€‚
                    `;
                    submitButton.disabled = true;
                    return;
                }
                
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        authStatusEl.innerHTML = `å·²ç™»å…¥ (ç”¨æˆ¶ ID: <span class="font-mono text-green-600">${userId}</span>)`;
                        submitButton.disabled = false;
                        isAuthReady = true;
                        setupDataListener();
                    } else {
                        await handleSignIn();
                    }
                });
            } catch (error) {
                console.error("Firebase åˆå§‹åŒ–å¤±æ•—:", error);
                authStatusEl.textContent = `åˆå§‹åŒ–éŒ¯èª¤: ${error.message}`;
            }
        }

        async function handleSignIn() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    // åœ¨é Canvas ç’°å¢ƒä¸‹ï¼Œä½¿ç”¨åŒ¿åç™»å…¥
                    await signInAnonymously(auth); 
                }
            } catch (error) {
                console.error("ç™»å…¥å¤±æ•—:", error);
                authStatusEl.textContent = `ç™»å…¥å¤±æ•—: ${error.message}`;
            }
        }
        
        // --- 2. è³‡æ–™æ“ä½œï¼šæ–°å¢ç¶­ä¿®é …ç›® (ä¿æŒä¸è®Š) ---
        async function addRepairItem(data) {
            if (!isAuthReady || !getCollectionRef()) {
                console.error("Firebase å°šæœªæº–å‚™å¥½æˆ–æœªç™»å…¥");
                document.getElementById('form-message').textContent = 'éŒ¯èª¤ï¼šç³»çµ±å°šæœªé€£ç·šåˆ°è³‡æ–™åº«ã€‚';
                document.getElementById('form-message').className = 'mt-3 text-sm text-red-500';
                return false;
            }

            try {
                await addDoc(getCollectionRef(), {
                    ...data,
                    status: STATUS_FLOW[0], // é è¨­ç‚º 'æ”¶åˆ°'
                    isToothingRequired: false,
                    isPlateCorrectionRequired: false,
                    notes: data.notes || '',
                    photos: { before: '', after: '' }, // åˆå§‹ç‚ºç©ºå­—ä¸²
                    timestamp: serverTimestamp()
                });
                
                // æ¸…ç©ºè¡¨å–® (é™¤äº†å ±åƒ¹æ—¥æœŸï¼Œä¿æŒç”¨æˆ¶ç¿’æ…£)
                document.getElementById('serial-number').value = '';
                document.getElementById('customer-name').value = '';
                document.getElementById('outer-diameter').value = '';
                document.getElementById('inner-bore').value = '';
                document.getElementById('thickness').value = '';
                document.getElementById('teeth-count').value = '';
                document.getElementById('function-type').value = '';
                document.getElementById('notes').value = '';

                return true;
            } catch (e) {
                console.error("æ–°å¢æ–‡ä»¶æ™‚ç™¼ç”ŸéŒ¯èª¤: ", e);
                return false;
            }
        }

        // --- 3. è³‡æ–™æ“ä½œï¼šæ›´æ–°ç¶­ä¿®é€²åº¦ (å·²èª¿æ•´ç…§ç‰‡æ¬„ä½æŠ“å– Base64) ---
        async function updateRepairItem(id, updateData) {
            if (!isAuthReady || !getCollectionRef()) {
                console.error("Firebase å°šæœªæº–å‚™å¥½æˆ–æœªç™»å…¥");
                modalMessage.textContent = 'éŒ¯èª¤ï¼šç³»çµ±å°šæœªæº–å‚™å¥½ã€‚';
                modalMessage.className = 'mt-3 text-sm text-red-500';
                return false;
            }

            try {
                const itemRef = doc(getCollectionRef(), id);
                await updateDoc(itemRef, updateData);
                modalMessage.textContent = 'æˆåŠŸæ›´æ–°ç¶­ä¿®å–®ç‹€æ…‹ï¼';
                modalMessage.className = 'mt-3 text-sm text-green-500';
                setTimeout(() => modalOverlay.classList.remove('open'), 1000);
                return true;
            } catch (e) {
                console.error("æ›´æ–°æ–‡ä»¶æ™‚ç™¼ç”ŸéŒ¯èª¤: ", e);
                modalMessage.textContent = `æ›´æ–°å¤±æ•—: ${e.message}`;
                modalMessage.className = 'mt-3 text-sm text-red-500';
                return false;
            }
        }
        
        // --- 4. è³‡æ–™ç›£è½èˆ‡ UI æ¸²æŸ“ (å³æ™‚æ›´æ–°) (ä¿æŒä¸è®Š) ---
        function setupDataListener() {
            const itemsRef = getCollectionRef();
            if (!itemsRef) return;

            const q = query(itemsRef); 

            onSnapshot(q, (querySnapshot) => {
                const items = [];
                querySnapshot.forEach((doc) => {
                    items.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                // æ’åº (ç¢ºä¿æœ€æ–°çš„åœ¨æœ€ä¸Šé¢)
                items.sort((a, b) => {
                    const tsA = a.timestamp?.seconds || 0;
                    const tsB = b.timestamp?.seconds || 0;
                    return tsB - tsA;
                });

                allItems = items;
                itemCountEl.textContent = allItems.length;
                
                // é‡æ–°æ¸²æŸ“ç•¶å‰æ¨¡å¼çš„æ¸…å–®
                if (currentMode === 'internal') {
                    renderItems(allItems);
                } else {
                    // å®¢æˆ¶æ¨¡å¼ä¸è‡ªå‹•æ¸²æŸ“ï¼Œéœ€æ‰‹å‹•æŸ¥è©¢
                    itemsTableBody.innerHTML = `<tr><td colspan="7" class="px-6 py-4 text-sm text-gray-500 text-center">åˆ‡æ›åˆ°å…¬å¸å…§éƒ¨è¦–åœ–ä»¥æŸ¥çœ‹æ‰€æœ‰æ¸…å–®ã€‚</td></tr>`;
                }

            }, (error) => {
                console.error("ç›£è½è³‡æ–™è®Šå‹•æ™‚ç™¼ç”ŸéŒ¯èª¤: ", error);
                itemsTableBody.innerHTML = `<tr><td colspan="7" class="px-6 py-4 text-center text-red-500">è¼‰å…¥éŒ¯èª¤: ${error.message}</td></tr>`;
            });
        }

        // æ¸²æŸ“ç¶­ä¿®é …ç›®æ¸…å–® (å…§éƒ¨è¦–åœ–) (ä¿æŒä¸è®Š)
        function renderItems(itemsToRender) {
            itemsTableBody.innerHTML = '';
            
            if (itemsToRender.length === 0) {
                 itemsTableBody.innerHTML = `<tr><td colspan="7" class="px-6 py-4 text-sm text-gray-500 text-center">ç›®å‰æ²’æœ‰ä»»ä½•ç¶­ä¿®é …ç›®è¨˜éŒ„ã€‚</td></tr>`;
                return;
            }

            itemsToRender.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-green-50 transition duration-150';
                
                const specText = `${item.outerDiameter || '-'} / ${item.innerBore || '-'} / ${item.thickness || '-'} / ${item.teethCount || '-'}`;
                const statusColor = item.status === 'å‡ºè²¨ (Shipped)' || item.status === 'å¾…å–ä»¶ (Ready for Pickup)' || item.status === 'å¾…å¯„è²¨ (Ready for Mail)' ? 'bg-info text-white' : (item.status === STATUS_FLOW[0] ? 'bg-gray-200 text-gray-700' : 'bg-secondary text-gray-900');
                const conditionalFlags = [];
                if (item.isToothingRequired) conditionalFlags.push('<span class="text-warning font-semibold">è£œé½’</span>');
                if (item.isPlateCorrectionRequired) conditionalFlags.push('<span class="text-warning font-semibold">æ ¡æ­£</span>');
                
                // é¡¯ç¤ºç‹€æ…‹
                const fullStatus = item.status.split(' (')[0] + (conditionalFlags.length > 0 ? ` (${conditionalFlags.join(', ')})` : '');

                row.innerHTML = `
                    <td class="px-3 py-4 text-sm text-gray-900">${item.customerName || '-'}</td>
                    <td class="px-3 py-4 text-sm font-bold text-primary">${item.serialNumber || '-'}</td>
                    <td class="px-3 py-4 text-sm text-gray-500">${item.quoteDate || '-'}</td>
                    <td class="px-3 py-4 text-xs text-gray-700 font-mono">${specText}</td>
                    <td class="px-3 py-4 text-sm text-gray-500">${item.functionType || '-'}</td>
                    <td class="px-3 py-4 text-sm">
                        <span class="status-pill ${statusColor}">
                            ${item.status.split(' (')[0]}
                        </span>
                    </td>
                    <td class="px-3 py-4 text-sm font-medium">
                        <button class="text-info hover:text-blue-700 transition duration-150 mr-2" 
                                onclick="window.showProgressModal('${item.id}')">
                            æ›´æ–°é€²åº¦
                        </button>
                        <button class="text-red-600 hover:text-red-900 transition duration-150" 
                                onclick="window.deleteItemHandler('${item.id}', '${item.serialNumber}')">
                            åˆªé™¤
                        </button>
                    </td>
                `;
                itemsTableBody.appendChild(row);
            });
        }


        // --- 5. æ¨¡æ…‹æ¡†èˆ‡é€²åº¦æ›´æ–°é‚è¼¯ (å·²èª¿æ•´ç…§ç‰‡æ¬„ä½è¼‰å…¥) ---
        
        // å°‹æ‰¾å–®ä¸€é …ç›®è³‡æ–™
        function findItemById(id) {
            return allItems.find(item => item.id === id);
        }

        // é¡¯ç¤ºæ¨¡æ…‹æ¡†
        window.showProgressModal = (id) => {
            const item = findItemById(id);
            if (!item) return;

            // 1. æ¸…é™¤èˆŠçš„æª”æ¡ˆé¸æ“‡ç‹€æ…‹å’Œé è¦½
            resetPhotoInputs();

            // 2. è¼‰å…¥æ–‡å­—è³‡æ–™
            modalItemId.value = item.id;
            modalItemInfo.textContent = `${item.customerName} (${item.serialNumber})`;
            modalStatusSelect.value = item.status;
            modalToothing.checked = item.isToothingRequired || false;
            modalPlateCorrection.checked = item.isPlateCorrectionRequired || false;
            modalNotes.value = item.notes || '';
            modalMessage.textContent = ''; // æ¸…é™¤èˆŠè¨Šæ¯

            // 3. è¼‰å…¥ Base64 æ•¸æ“šåˆ°éš±è—æ¬„ä½ä¸¦æ›´æ–°é è¦½
            const photoBeforeData = item.photos?.before || '';
            const photoAfterData = item.photos?.after || '';

            modalBase64Before.value = photoBeforeData;
            updatePreview(photoBeforeData, modalPreviewBefore, 'ç¶­ä¿®å‰é è¦½åœ–');

            modalBase64After.value = photoAfterData;
            updatePreview(photoAfterData, modalPreviewAfter, 'å‡ºè²¨å‰é è¦½åœ–');


            modalOverlay.classList.add('open');
        };

        // éš±è—æ¨¡æ…‹æ¡†
        modalCloseBtn.addEventListener('click', () => {
            modalOverlay.classList.remove('open');
            resetPhotoInputs(); // é—œé–‰æ™‚æ¸…ç©ºé è¦½ï¼Œé˜²æ­¢ä¸‹æ¬¡æ‰“é–‹æ±¡æŸ“
        });

        // æäº¤æ¨¡æ…‹æ¡†çš„æ›´æ–°
        progressForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = modalItemId.value;
            
            // å¾éš±è—çš„ Base64 æ¬„ä½ä¸­æŠ“å–æ•¸æ“š
            const updateData = {
                status: modalStatusSelect.value,
                isToothingRequired: modalToothing.checked,
                isPlateCorrectionRequired: modalPlateCorrection.checked,
                photos: {
                    before: modalBase64Before.value, // Base64 æ•¸æ“š
                    after: modalBase64After.value   // Base64 æ•¸æ“š
                },
                notes: modalNotes.value
            };

            await updateRepairItem(id, updateData);
        });

        // --- 6. å®¢æˆ¶æŸ¥è©¢é‚è¼¯ (å·²èª¿æ•´åœ–ç‰‡è¼‰å…¥é‚è¼¯) ---

        runCustomerSearchBtn.addEventListener('click', () => {
            const serial = customerSerialSearch.value.trim();
            const name = customerNameSearch.value.trim();
            const date = customerDateSearch.value.trim();

            customerSearchMessage.textContent = '';
            customerResultContainer.classList.add('hidden');
            
            let resultItem = null;

            // å„ªå…ˆä»¥ç·¨è™ŸæŸ¥è©¢ (ä¸è«–å¤§å°å¯«)
            if (serial) {
                const serialLower = serial.toLowerCase();
                resultItem = allItems.find(item => item.serialNumber && item.serialNumber.toLowerCase() === serialLower);
            } else if (name && date) {
                // çµ„åˆæŸ¥è©¢: å®¢æˆ¶åç¨± (ä¸è«–å¤§å°å¯«) + å ±åƒ¹æ—¥æœŸ (ç²¾ç¢º)
                const nameLower = name.toLowerCase();
                resultItem = allItems.find(item => 
                    item.customerName && item.customerName.toLowerCase() === nameLower && 
                    item.quoteDate === date
                );
            }
            
            if (resultItem) {
                displayCustomerResult(resultItem);
            } else {
                customerSearchMessage.textContent = 'æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„ç¶­ä¿®å–®ï¼Œè«‹æª¢æŸ¥æ‚¨çš„è¼¸å…¥ã€‚';
                customerSearchMessage.className = 'mt-4 text-base font-medium text-red-500 p-2 bg-red-100 rounded-lg';
            }
        });

        function displayCustomerResult(item) {
            customerSearchMessage.textContent = '';
            customerResultContainer.classList.remove('hidden');
            
            // æ¨™é ­è³‡è¨Š
            document.getElementById('customer-result-name').textContent = item.customerName;
            document.getElementById('customer-result-serial').textContent = item.serialNumber;
            
            // --- é€²åº¦æ¢é‚è¼¯ (ä¿æŒä¸è®Š) ---
            
            const currentStatusText = item.status.split(' (')[0];
            const currentStatusIndex = STATUS_FLOW.findIndex(s => s === item.status);
            
            let progressHtml = '';
            const stepCount = PROGRESS_STEPS.length;
            const progressPercentage = Math.min(100, (currentStatusIndex / (stepCount - 1)) * 100);

            // 1. ç¹ªè£½é€²åº¦æ¢æ­¥é©Ÿ
            customerProgressDisplay.innerHTML = ''; // æ¸…é™¤èˆŠçš„æ­¥é©Ÿ
            PROGRESS_STEPS.forEach((step, index) => {
                let statusClass = 'step-pending';
                let icon = index + 1; // é è¨­ç‚ºæ•¸å­—
                let label = step;
                
                if (index < currentStatusIndex) {
                    statusClass = 'step-done';
                    icon = 'âœ“';
                } else if (index === currentStatusIndex && index < stepCount) {
                    statusClass = 'step-current';
                    icon = 'â–¶';
                }

                progressHtml += `
                    <div class="progress-step ${statusClass}" style="width: ${100/stepCount}%;">
                        <div class="step-indicator">${icon}</div>
                        <div class="step-label">${label}</div>
                    </div>
                `;
            });
            
            customerProgressDisplay.innerHTML = progressHtml;
            progressBarFill.style.width = `${progressPercentage}%`;

            // 2. è™•ç†å®Œæˆ/å‡ºè²¨ç‹€æ…‹ (åœ¨é€²åº¦æ¢ä¸‹æ–¹ç¨ç«‹é¡¯ç¤º)
            // ç”±æ–¼æ¯æ¬¡æœƒé‡æ–°ç”Ÿæˆï¼Œå…ˆåˆªé™¤èˆŠçš„ finalStatusHtml (å¦‚æœå­˜åœ¨)
            const oldFinalStatus = document.getElementById('final-status-display');
            if (oldFinalStatus) oldFinalStatus.remove();

            let finalStatusHtml = '';
            if (currentStatusIndex >= 7) {
                 const finalStatusText = FINAL_STEPS.find(s => item.status.includes(s));
                 finalStatusHtml = `
                    <div id="final-status-display" class="mt-6 p-4 bg-info text-white rounded-lg shadow-md flex items-center justify-center font-bold text-xl">
                        ğŸ“¦ ${finalStatusText || 'å·²å®Œæˆ'}ï¼šè«‹æº–å‚™æ”¶è²¨æˆ–å–ä»¶
                    </div>
                 `;
            } else {
                // é¡¯ç¤ºç›®å‰é€²åº¦
                finalStatusHtml = `
                    <div id="final-status-display" class="mt-6 p-4 bg-primary/20 text-primary rounded-lg shadow-sm font-bold text-lg text-center">
                        ğŸƒ ç•¶å‰è™•ç†ä¸­ï¼š**${currentStatusText}**
                    </div>
                `;
            }
            customerResultContainer.querySelector('.relative.pt-1.mb-8').insertAdjacentHTML('beforeend', finalStatusHtml);


            // 3. è™•ç†ç‰¹æ®Šé …ç›® (è£œé½’/æ ¡æ­£)
            document.getElementById('toothing-status').innerHTML = `è£œé½’: <span class="font-bold ${item.isToothingRequired ? 'text-warning' : 'text-gray-500'}">${item.isToothingRequired ? 'æ˜¯ (é€²è¡Œä¸­)' : 'å¦'}</span>`;
            document.getElementById('correction-status').innerHTML = `é‹¼æ¿æ ¡æ­£: <span class="font-bold ${item.isPlateCorrectionRequired ? 'text-warning' : 'text-gray-500'}">${item.isPlateCorrectionRequired ? 'æ˜¯ (é€²è¡Œä¸­)' : 'å¦'}</span>`;


            // 4. è™•ç†ç…§ç‰‡ (èª¿æ•´ç‚ºæ”¯æ´ Base64)
            photoBeforeContainer.innerHTML = '';
            photoAfterContainer.innerHTML = '';
            photoPendingMessage.textContent = '';

            const photoStyle = "w-full h-auto max-h-80 object-contain rounded-lg shadow-lg border-2 border-primary/50";
            const photoBefore = item.photos?.before || '';
            const photoAfter = item.photos?.after || '';

            // ç¶­ä¿®å‰ç…§ç‰‡
            if (photoBefore) {
                // ç”±æ–¼ç¾åœ¨æ˜¯ Base64 æ•¸æ“šï¼Œä¸éœ€è¦ onerror è™•ç† placeholder
                photoBeforeContainer.innerHTML = `
                    <h5 class="font-semibold text-primary mb-2">ç¶­ä¿®å‰ç…§ç‰‡</h5>
                    <img src="${photoBefore}" class="${photoStyle}">
                `;
            } else {
                 photoBeforeContainer.innerHTML = `<p class="text-gray-400 text-sm">ç¶­ä¿®å‰ç…§ç‰‡æœªæä¾›ã€‚</p>`;
            }

            // å‡ºè²¨å‰ç…§ç‰‡
            if (photoAfter) {
                photoAfterContainer.innerHTML = `
                    <h5 class="font-semibold text-info mb-2 mt-4">å‡ºè²¨å‰ç…§ç‰‡ (å·²å®Œæˆ)</h5>
                    <img src="${photoAfter}" class="${photoStyle}">
                `;
            } else if (currentStatusIndex >= 6) { // æª¢æŸ¥ä¹‹å¾Œæ‡‰è©²è¦æœ‰å‡ºè²¨ç…§
                 photoPendingMessage.textContent = 'ğŸ’¡ å‡ºè²¨å‰ç…§ç‰‡å°šæœªä¸Šå‚³ï¼Œè«‹ç¨å€™ã€‚';
            } else {
                 photoPendingMessage.textContent = 'ç…§ç‰‡å°‡åœ¨ã€Œæª¢æŸ¥ã€éšæ®µå¾Œé™¸çºŒä¸Šå‚³ã€‚';
            }
        }

        // --- 7. æ¨¡å¼åˆ‡æ›èˆ‡é€šç”¨äº‹ä»¶è™•ç† (ä¿æŒä¸è®Š) ---
        
        function setViewMode(mode) {
            currentMode = mode;
            if (mode === 'internal') {
                modeInternalBtn.classList.replace('bg-white', 'bg-primary');
                modeInternalBtn.classList.replace('text-primary', 'text-white');
                modeCustomerBtn.classList.replace('bg-primary', 'bg-white');
                modeCustomerBtn.classList.replace('text-white', 'text-primary');

                addItemSection.classList.remove('hidden');
                itemListSection.classList.remove('hidden');
                customerSearchSection.classList.add('hidden');
                renderItems(allItems); // å…§éƒ¨æ¨¡å¼ï¼šé¡¯ç¤ºå…¨éƒ¨æ¸…å–®
            } else {
                modeInternalBtn.classList.replace('bg-primary', 'bg-white');
                modeInternalBtn.classList.replace('text-white', 'text-primary');
                modeCustomerBtn.classList.replace('bg-white', 'bg-primary');
                modeCustomerBtn.classList.replace('text-primary', 'text-white');
                
                addItemSection.classList.add('hidden');
                itemListSection.classList.add('hidden');
                customerSearchSection.classList.remove('hidden');
                itemsTableBody.innerHTML = `<tr><td colspan="7" class="px-6 py-4 text-sm text-gray-500 text-center">åˆ‡æ›åˆ°å…¬å¸å…§éƒ¨è¦–åœ–ä»¥æŸ¥çœ‹æ‰€æœ‰æ¸…å–®ã€‚</td></tr>`;
            }
        }

        modeInternalBtn.addEventListener('click', () => setViewMode('internal'));
        modeCustomerBtn.addEventListener('click', () => setViewMode('customer'));


        // è™•ç†è¡¨å–®æäº¤ (ä¿æŒä¸è®Š)
        itemForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const serialNumber = document.getElementById('serial-number').value.trim();
            const customerName = document.getElementById('customer-name').value.trim();
            const quoteDate = document.getElementById('quote-date').value.trim();
            const outerDiameter = document.getElementById('outer-diameter').value.trim();
            const innerBore = document.getElementById('inner-bore').value.trim();
            const thickness = document.getElementById('thickness').value.trim();
            const teethCount = document.getElementById('teeth-count').value.trim();
            const functionType = document.getElementById('function-type').value.trim();
            const notes = document.getElementById('notes').value.trim();

            if (serialNumber && customerName && quoteDate) {
                submitButton.disabled = true;
                submitButton.textContent = 'æ–°å¢ä¸­...';
                
                const repairData = {
                    serialNumber, customerName, quoteDate, outerDiameter, innerBore,
                    thickness, teethCount, functionType, notes
                };

                const success = await addRepairItem(repairData);
                
                const formMessageEl = document.getElementById('form-message');
                if (success) {
                    formMessageEl.textContent = `æˆåŠŸæ–°å¢é …ç›®: ${customerName} (ç·¨è™Ÿ: ${serialNumber})`;
                    formMessageEl.className = 'mt-3 text-sm text-green-500';
                } else {
                    formMessageEl.textContent = `æ–°å¢å¤±æ•—ï¼Œè«‹æŸ¥çœ‹æ§åˆ¶å°éŒ¯èª¤ã€‚`;
                    formMessageEl.className = 'mt-3 text-sm text-red-500';
                }
                setTimeout(() => formMessageEl.textContent = '', 3000);

                submitButton.textContent = 'æ–°å¢ç¶­ä¿®é …ç›®';
                submitButton.disabled = false;
            }
        });

        // è™•ç†æŸ¥è©¢è¼¸å…¥ (å…§éƒ¨æ¨¡å¼) (ä¿æŒä¸è®Š)
        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase().trim();
            
            if (searchTerm === '') {
                renderItems(allItems);
                return;
            }

            // ç¯©é¸é‚è¼¯ï¼šæ¯”å° å®¢æˆ¶ç·¨è™Ÿã€å®¢æˆ¶åç¨±ã€å ±åƒ¹æ—¥æœŸæˆ–ä»»ä½•è¦æ ¼
            const filteredItems = allItems.filter(item => 
                (item.customerName && item.customerName.toLowerCase().includes(searchTerm)) || 
                (item.serialNumber && item.serialNumber.toLowerCase().includes(searchTerm)) ||
                (item.quoteDate && item.quoteDate.includes(searchTerm)) ||
                (item.outerDiameter && item.outerDiameter.toLowerCase().includes(searchTerm)) ||
                (item.innerBore && item.innerBore.toLowerCase().includes(searchTerm)) ||
                (item.thickness && item.thickness.toLowerCase().includes(searchTerm)) ||
                (item.teethCount && item.teethCount.toLowerCase().includes(searchTerm)) ||
                (item.functionType && item.functionType.toLowerCase().includes(searchTerm))
            );

            renderItems(filteredItems);
        });

        // åˆªé™¤å‡½æ•¸ (ä¿æŒä¸è®Š)
        window.deleteItemHandler = async (id, serialNumber) => {
            if (!isAuthReady || !getCollectionRef()) {
                console.error("Firebase å°šæœªæº–å‚™å¥½æˆ–æœªç™»å…¥");
                return;
            }

            // ä½¿ç”¨åŸç”Ÿçš„ confirm() æ˜¯ä¸æ¨è–¦çš„ï¼Œä½†ç‚ºäº†å¿«é€Ÿå¯¦ç¾ï¼Œæˆ‘å€‘å°‡å…¶è¦–ç‚ºå…§éƒ¨æ“ä½œ
            if (!window.confirm(`ç¢ºå®šè¦åˆªé™¤å®¢æˆ¶ç·¨è™Ÿç‚º ${serialNumber} (å…§éƒ¨ ID: ${id}) çš„é …ç›®å—ï¼Ÿ`)) {
                return;
            }

            try {
                await deleteDoc(doc(getCollectionRef(), id));
            } catch (e) {
                console.error("åˆªé™¤æ–‡ä»¶æ™‚ç™¼ç”ŸéŒ¯èª¤: ", e);
            }
        };

        // è‡ªå®šç¾©è¨Šæ¯é¡¯ç¤º (ä»£æ›¿ alert)
        function showCustomMessage(message, type = 'info') {
            const tempMessageEl = document.createElement('div');
            tempMessageEl.textContent = message;
            tempMessageEl.className = `fixed top-4 right-4 p-4 rounded-lg shadow-xl text-white z-50 transition-all duration-300 ${type === 'error' ? 'bg-red-500' : 'bg-info'}`;
            document.body.appendChild(tempMessageEl);
            setTimeout(() => {
                tempMessageEl.remove();
            }, 4000);
        }

        // åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼
        window.onload = () => {
            // é è¨­å°‡å ±åƒ¹æ—¥æœŸè¨­ç‚ºä»Šå¤©
            document.getElementById('quote-date').valueAsDate = new Date();
            initializeFirebase();
            setViewMode('internal'); // é è¨­ç‚ºå…§éƒ¨ç®¡ç†æ¨¡å¼
        }
    </script>
</body>
</html>
